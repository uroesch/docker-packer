#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# Setup
# -----------------------------------------------------------------------------
set -o errexit
set -o nounset
set -o pipefail

# -----------------------------------------------------------------------------
# Globals
# -----------------------------------------------------------------------------
declare -g TTY=
declare -g INTERACTIVE=
declare -g NOVNC_PORT=6180

# -----------------------------------------------------------------------------
# Functions
# -----------------------------------------------------------------------------
function has_tty() {
  [[ ! -t 1 ]] && return 0
  TTY=true
  INTERACTIVE=true
}


# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------
has_tty
docker run \
  --rm \
  ${TTY:+--tty} \
  ${INTERACTIVE:+--interactive} \
  --privileged \
  --volume "$(pwd):$(pwd)" \
  --workdir "$(pwd)" \
  --expose 5900-5999 \
  --publish ${NOVNC_PORT}:${NOVNC_PORT} \
  --env USER_NAME="$(id -un)" \
  --env USER_UID="$(id -u)" \
  --env USER_GID="$(id -g)" \
  uroesch/packer:latest \
  "${@}"
